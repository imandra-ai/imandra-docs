<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>imandra.auth API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>imandra.auth</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">import random
import uuid
import json
import os
import os.path
import sys

import urllib
import urllib.error
import urllib.parse
import urllib.request

import hashlib
import base64

import shutil
import webbrowser

def _get_secrets():
    rchar = lambda: random.SystemRandom().choice(_get_secrets.chars)
    verifier = bytes(rchar() for _ in range(32))
    challenge = hashlib.sha256(verifier).digest()
    challenge = base64.b64encode(challenge, altchars=b&#34;-_&#34;)
    challenge = challenge.replace(b&#34;=&#34;,b&#34;&#34;)
    return verifier, challenge

_get_secrets.chars = b&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;

class Auth:
    &#34;&#34;&#34;
    Auth encapsulates authentication information for Imandra&#39;s Cloud APIs at
    https://www.imandra.ai/api/. An instance of this class should be passed to
    other ``imandra`` library methods to make calls to Imandra&#39;s cloud APIs.
    &#34;&#34;&#34;
    def __init__(self):
        &#34;&#34;&#34;
        Construct a new Auth object. This constructor configures the object
        with the locations of the Imandra authentication on your local machine
        (e.g. from ``~/.imandra`` or `%APPDATA%\imandra`), and the Imandra cloud API
        details.
        &#34;&#34;&#34;

        envs = {&#39;dev&#39;:
                {&#39;auth0_base_host&#39;: &#34;test-ai.eu.auth0.com&#34;,
                 &#39;auth0_client_id&#39;: &#34;DQs4kqaeTPAENZ8dAj64qEm2SbJgncNK&#34;,
                 &#39;auth0_audience&#39;: &#34;https://www.dev.imandracapital.com/api&#34;,
                 &#39;imandra_web_host&#39;: &#39;https://www.dev.imandracapital.com&#39;,
                 &#39;config_dir_name&#39;: &#34;imandra-dev&#34;,
                 &#39;imandra_repl&#39;: &#39;imandra-repl-dev&#39;
                },
                &#39;prod&#39;:
                {&#39;auth0_base_host&#39;: &#34;auth.imandra.ai&#34;,
                 &#39;auth0_client_id&#39;: &#34;q2yGHBTLmJSia35zCOdkUpEecj9mQl6o&#34;,
                 &#39;auth0_audience&#39;: &#34;https://www.imandra.ai/api&#34;,
                 &#39;imandra_web_host&#39;: &#34;https://www.imandra.ai&#34;,
                 &#39;config_dir_name&#39;: &#34;imandra&#34;,
                 &#39;imandra_repl&#39;: &#39;imandra-repl&#39;}}

        env = os.getenv(&#34;IMANDRA_ENV&#34;, &#39;prod&#39;)

        self.auth0_base_host  = envs[env][&#39;auth0_base_host&#39;]
        self.auth0_client_id  = envs[env][&#39;auth0_client_id&#39;]
        self.auth0_audience   = envs[env][&#39;auth0_audience&#39;]
        self.imandra_web_host = envs[env][&#39;imandra_web_host&#39;]
        self.imandra_repl     = envs[env][&#39;imandra_repl&#39;]
        self.http_port        = None

        if os.name == &#39;nt&#39;:
            user_config_root = os.environ[&#39;APPDATA&#39;]
            self.folder_path      =  os.path.join(user_config_root, envs[env][&#39;config_dir_name&#39;])
        else:
            user_config_root = os.environ[&#39;HOME&#39;]
            self.folder_path      =  os.path.join(user_config_root, &#34;.&#34; + envs[env][&#39;config_dir_name&#39;])


        self.redirect_uri = self.imandra_web_host + &#34;/pkce-callback&#34;
        if self.http_port:
            self.redirect_uri += &#34;?redirect_port=&#34; + str(self.http_port)


    def login(self):
        &#34;&#34;&#34;
        Ensures that all information is present in order to make calls to the
        API. This method is best run interactively from `imandra-cli`, via
        `imandra auth login`.
        &#34;&#34;&#34;
        self.ensure_folder()
        self.ensure_token()
        self.ensure_confirm()
        self.ensure_zone()

    def logout(self):
        &#34;&#34;&#34;
        Remove all Imandra user configuration information on the local machine.
        &#34;&#34;&#34;
        self.ensure_folder()
        shutil.rmtree(self.folder_path)


    def ensure_folder(self):
        &#34;&#34;&#34;
        Ensures the existence of the local imandra configuration directory (`~/.imandra` or `%APPDATA%\imandra`).
        &#34;&#34;&#34;
        if not os.path.exists(self.folder_path):
            os.mkdir(self.folder_path)

        device_id_path = os.path.join(self.folder_path, &#34;device_id&#34;)
        if not os.path.exists(device_id_path):
            self.device_id = str(uuid.uuid4())
            with open(device_id_path, &#39;w&#39;) as device_id_file:
                device_id_file.write(self.device_id)
        else:
            with open(device_id_path, &#39;r&#39;) as device_id_file:
                self.device_id = device_id_file.read()


    def ensure_token(self):
        &#34;&#34;&#34;
        Ensures the existence of the local imandra login token. Prompts the user to log in if there isn&#39;t one.
        &#34;&#34;&#34;
        token_path = os.path.join(self.folder_path, &#34;login_token&#34;)
        if os.path.exists(token_path):
            with open(token_path, &#39;r&#39;) as token_file:
                self.token = token_file.read().strip()
            return

        self.verifier, self.challenge = _get_secrets()
        link = self._make_link()
        try:
            webbrowser.open(link)
        except webbrowser.Error:
            print(&#34;We need to authenticate you! Please open: \n{}&#34;.format(link))
        code_str = str(input(&#34;Enter the code provided on the page above: &#34;)).strip()
        self._exchange_tokens(code_str, token_path)

    def ensure_zone(self):
        &#34;&#34;&#34;
        Ensures the existence of the default zone for creation of Imandra core
        instances. Pick the zone closest to you from those available to reduce
        latency when interacting with Imandra Core instances.
        &#34;&#34;&#34;
        zone_path = os.path.join(self.folder_path, &#34;zone&#34;)
        if os.path.exists(zone_path):
            with open(zone_path, &#39;r&#39;) as zone_file:
                self.zone = zone_file.read().strip()
            return


        path = &#34;pod/clusters&#34;
        url = &#34;{}/{}&#34;.format(self.imandra_web_host, path)
        headers = { &#34;X-Auth&#34; : self.token }

        request = urllib.request.Request(url, headers=headers)

        try:
            response = urllib.request.urlopen(request)
        except urllib.error.HTTPError as e:
            raise ValueError(e.read())
        j = json.loads(response.read())

        options = []
        option_strs = []
        for i, cluster in enumerate(j[&#34;clusters&#34;]):
            options.append((i, cluster))
            option_strs.append(&#34;[{}] {}&#34;.format(str(i + 1), cluster))

        def ask_for_selection():
            query = input(&#34;Select cloud zone {} : &#34;.format(&#34; &#34;.join(option_strs)))
            try:
                return int(query) - 1
            except ValueError:
                print(&#34;Not a valid selection&#34;)
                ask_for_selection()

        selected_opt_idx = ask_for_selection()
        _, selected_cluster = options[selected_opt_idx]

        with open(zone_path, &#39;w&#39;) as zone_file:
            zone_file.write(selected_cluster)

        self.zone = selected_cluster

    def _make_link(self):
        params = urllib.parse.urlencode(\
          { &#34;audience&#34;       : self.auth0_audience
          , &#34;response_type&#34;  : &#34;code&#34;
          , &#34;client_id&#34;      : self.auth0_client_id
          , &#34;code_challenge&#34; : self.challenge
          , &#34;code_challenge_method&#34; : &#34;S256&#34;
          , &#34;redirect_uri&#34;   : self.redirect_uri
          })
        return &#34;https://{}/{}?{}&#34;.format(self.auth0_base_host, &#34;authorize&#34;, params)

    def _prompt_verify_email(self):
        query = input(&#34;Enter the verification code we sent to your email: &#34;)
        evrid, token, intention = base64.b64decode(query.encode(), altchars=b&#34;-_&#34;).decode(&#34;utf8&#34;).split(&#34;,&#34;)
        params = urllib.parse.urlencode(\
          { &#34;evrid&#34; : evrid
          , &#34;token&#34; : token
          , &#34;intention&#34; : intention })
        url = &#34;{}/{}?{}&#34;.format(self.imandra_web_host, &#34;verify-email&#34;, params)
        headers = { &#34;X-Device-Id&#34;   : self.device_id}
        request = urllib.request.Request(url, headers=headers)
        try:
            response = urllib.request.urlopen(request)
        except urllib.error.HTTPError as e:
            raise ValueError(e.read())

    def _exchange_tokens(self, code_str, token_path):
        tkn = \
          { &#34;grant_type&#34;    : &#34;authorization_code&#34;
          , &#34;client_id&#34;     : self.auth0_client_id
          , &#34;code_verifier&#34; : self.verifier.decode(&#34;utf-8&#34;)
          , &#34;code&#34;          : code_str
          , &#34;redirect_uri&#34;  : self.redirect_uri
          }
        url = &#34;https://{}/{}&#34;.format(self.auth0_base_host, &#34;oauth/token&#34;)
        data = json.dumps(tkn)
        clen = len(data)
        data = data.encode(&#34;utf-8&#34;)
        request = urllib.request.Request(url, data, {&#39;Content-Type&#39;: &#39;application/json&#39;, &#39;Content-Length&#39;: clen})
        try:
            response = urllib.request.urlopen(request)
        except urllib.error.HTTPError as e:
            raise ValueError(e.read())
        auth_token = json.loads(response.read())
        headers = \
          { &#34;Authorization&#34; : &#34;Bearer {}&#34;.format(auth_token[&#39;access_token&#39;])
          , &#34;X-Device-Id&#34;   : self.device_id
          }
        url = &#34;{}/{}&#34;.format(self.imandra_web_host, &#34;api/login-token-for&#34;)
        request = urllib.request.Request(url, headers=headers)
        try:
            response = urllib.request.urlopen(request)
            self.token = response.read().decode(&#34;utf-8&#34;)

            with open(token_path, &#39;w&#39;) as token_file:
                token_file.write(self.token)

        except urllib.error.HTTPError as e:
            content = e.read().decode(&#34;utf-8&#34;)
            if e.code == 400 and content == &#34;email-not-verified&#34;:
                self._prompt_verify_email()
                self.ensure_token()
            else:
                raise ValueError(content)

    def ensure_confirm(self):
        path = &#34;api/user-info&#34;
        url = &#34;{}/{}&#34;.format(self.imandra_web_host, path)
        headers = { &#34;X-Auth&#34; : self.token }

        request = urllib.request.Request(url, headers=headers)

        try:
            response = urllib.request.urlopen(request)
        except urllib.error.HTTPError as e:
            raise ValueError(e.read())
        j = json.loads(response.read())
        if not j[&#34;trial_activated&#34;]:
            query = input(&#34;Do you want to start your Imandra trial? [Y/n] &#34;)
            if query == &#34;&#34; or query[0].lower() == &#34;y&#34;:
                path = &#34;welcome/activate-trial&#34;
                url = &#34;{}/{}&#34;.format(self.imandra_web_host, path)
                request = urllib.request.Request(url, headers=headers)
                try:
                    response = urllib.request.urlopen(request)
                except urllib.error.HTTPError as e:
                    raise ValueError(e.read())
            else:
                raise ValueError(&#34;Trial not activated&#34;)

    def export(self):
        &#34;&#34;&#34;
        Export your login details for use via another Imandra Cloud API client.
        &#34;&#34;&#34;
        token_path = os.path.join(self.folder_path, &#34;login_token&#34;)
        zone_path = os.path.join(self.folder_path, &#34;zone&#34;)
        on_behalf_of_path = os.path.join(self.folder_path, &#34;on_behalf_of&#34;)

        if not os.path.exists(token_path) or not os.path.exists(zone_path):
            raise ValueError(&#34;Not logged in&#34;)

        details = {}
        with open(token_path, &#39;r&#39;) as token_file:
            details[&#39;auth&#39;] = token_file.read().strip()

        with open(zone_path, &#39;r&#39;) as zone_file:
            details[&#39;zone&#39;] = zone_file.read().strip()

        if os.path.exists(on_behalf_of_path):
            with open(on_behalf_of_path, &#39;r&#39;) as on_behalf_of_file:
                details[&#39;on_behalf_of&#39;] = on_behalf_of_file.read().strip()
        else:
            details[&#39;on_behalf_of&#39;] = None

        print(json.dumps(details))

    def import_(self):
        &#34;&#34;&#34;
        Import your login details from stdin.
        &#34;&#34;&#34;
        token_path = os.path.join(self.folder_path, &#34;login_token&#34;)
        zone_path = os.path.join(self.folder_path, &#34;zone&#34;)
        on_behalf_of_path = os.path.join(self.folder_path, &#34;on_behalf_of&#34;)

        lines = []
        for line in sys.stdin:
            lines.append(line)

        j = json.loads(&#34;\n&#34;.join(lines))

        if j.get(&#39;auth&#39;):
            self.ensure_folder()
            with open(token_path, &#39;w&#39;) as f:
                f.write(j[&#39;auth&#39;])

        if j.get(&#39;zone&#39;):
            self.ensure_folder()
            with open(zone_path, &#39;w&#39;) as f:
                f.write(j[&#39;zone&#39;])

        if j.get(&#39;on_behalf_of&#39;):
            self.ensure_folder()
            with open(on_behalf_of_path, &#39;w&#39;) as f:
                f.write(j[&#39;zone&#39;])</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="imandra.auth.Auth"><code class="flex name class">
<span>class <span class="ident">Auth</span></span>
</code></dt>
<dd>
<div class="desc"><p>Auth encapsulates authentication information for Imandra's Cloud APIs at
<a href="https://www.imandra.ai/api/.">https://www.imandra.ai/api/.</a> An instance of this class should be passed to
other <code><a title="imandra" href="index.html">imandra</a></code> library methods to make calls to Imandra's cloud APIs.</p>
<p>Construct a new Auth object. This constructor configures the object
with the locations of the Imandra authentication on your local machine
(e.g. from <code>~/.imandra</code> or <code>%APPDATA%\imandra</code>), and the Imandra cloud API
details.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class Auth:
    &#34;&#34;&#34;
    Auth encapsulates authentication information for Imandra&#39;s Cloud APIs at
    https://www.imandra.ai/api/. An instance of this class should be passed to
    other ``imandra`` library methods to make calls to Imandra&#39;s cloud APIs.
    &#34;&#34;&#34;
    def __init__(self):
        &#34;&#34;&#34;
        Construct a new Auth object. This constructor configures the object
        with the locations of the Imandra authentication on your local machine
        (e.g. from ``~/.imandra`` or `%APPDATA%\imandra`), and the Imandra cloud API
        details.
        &#34;&#34;&#34;

        envs = {&#39;dev&#39;:
                {&#39;auth0_base_host&#39;: &#34;test-ai.eu.auth0.com&#34;,
                 &#39;auth0_client_id&#39;: &#34;DQs4kqaeTPAENZ8dAj64qEm2SbJgncNK&#34;,
                 &#39;auth0_audience&#39;: &#34;https://www.dev.imandracapital.com/api&#34;,
                 &#39;imandra_web_host&#39;: &#39;https://www.dev.imandracapital.com&#39;,
                 &#39;config_dir_name&#39;: &#34;imandra-dev&#34;,
                 &#39;imandra_repl&#39;: &#39;imandra-repl-dev&#39;
                },
                &#39;prod&#39;:
                {&#39;auth0_base_host&#39;: &#34;auth.imandra.ai&#34;,
                 &#39;auth0_client_id&#39;: &#34;q2yGHBTLmJSia35zCOdkUpEecj9mQl6o&#34;,
                 &#39;auth0_audience&#39;: &#34;https://www.imandra.ai/api&#34;,
                 &#39;imandra_web_host&#39;: &#34;https://www.imandra.ai&#34;,
                 &#39;config_dir_name&#39;: &#34;imandra&#34;,
                 &#39;imandra_repl&#39;: &#39;imandra-repl&#39;}}

        env = os.getenv(&#34;IMANDRA_ENV&#34;, &#39;prod&#39;)

        self.auth0_base_host  = envs[env][&#39;auth0_base_host&#39;]
        self.auth0_client_id  = envs[env][&#39;auth0_client_id&#39;]
        self.auth0_audience   = envs[env][&#39;auth0_audience&#39;]
        self.imandra_web_host = envs[env][&#39;imandra_web_host&#39;]
        self.imandra_repl     = envs[env][&#39;imandra_repl&#39;]
        self.http_port        = None

        if os.name == &#39;nt&#39;:
            user_config_root = os.environ[&#39;APPDATA&#39;]
            self.folder_path      =  os.path.join(user_config_root, envs[env][&#39;config_dir_name&#39;])
        else:
            user_config_root = os.environ[&#39;HOME&#39;]
            self.folder_path      =  os.path.join(user_config_root, &#34;.&#34; + envs[env][&#39;config_dir_name&#39;])


        self.redirect_uri = self.imandra_web_host + &#34;/pkce-callback&#34;
        if self.http_port:
            self.redirect_uri += &#34;?redirect_port=&#34; + str(self.http_port)


    def login(self):
        &#34;&#34;&#34;
        Ensures that all information is present in order to make calls to the
        API. This method is best run interactively from `imandra-cli`, via
        `imandra auth login`.
        &#34;&#34;&#34;
        self.ensure_folder()
        self.ensure_token()
        self.ensure_confirm()
        self.ensure_zone()

    def logout(self):
        &#34;&#34;&#34;
        Remove all Imandra user configuration information on the local machine.
        &#34;&#34;&#34;
        self.ensure_folder()
        shutil.rmtree(self.folder_path)


    def ensure_folder(self):
        &#34;&#34;&#34;
        Ensures the existence of the local imandra configuration directory (`~/.imandra` or `%APPDATA%\imandra`).
        &#34;&#34;&#34;
        if not os.path.exists(self.folder_path):
            os.mkdir(self.folder_path)

        device_id_path = os.path.join(self.folder_path, &#34;device_id&#34;)
        if not os.path.exists(device_id_path):
            self.device_id = str(uuid.uuid4())
            with open(device_id_path, &#39;w&#39;) as device_id_file:
                device_id_file.write(self.device_id)
        else:
            with open(device_id_path, &#39;r&#39;) as device_id_file:
                self.device_id = device_id_file.read()


    def ensure_token(self):
        &#34;&#34;&#34;
        Ensures the existence of the local imandra login token. Prompts the user to log in if there isn&#39;t one.
        &#34;&#34;&#34;
        token_path = os.path.join(self.folder_path, &#34;login_token&#34;)
        if os.path.exists(token_path):
            with open(token_path, &#39;r&#39;) as token_file:
                self.token = token_file.read().strip()
            return

        self.verifier, self.challenge = _get_secrets()
        link = self._make_link()
        try:
            webbrowser.open(link)
        except webbrowser.Error:
            print(&#34;We need to authenticate you! Please open: \n{}&#34;.format(link))
        code_str = str(input(&#34;Enter the code provided on the page above: &#34;)).strip()
        self._exchange_tokens(code_str, token_path)

    def ensure_zone(self):
        &#34;&#34;&#34;
        Ensures the existence of the default zone for creation of Imandra core
        instances. Pick the zone closest to you from those available to reduce
        latency when interacting with Imandra Core instances.
        &#34;&#34;&#34;
        zone_path = os.path.join(self.folder_path, &#34;zone&#34;)
        if os.path.exists(zone_path):
            with open(zone_path, &#39;r&#39;) as zone_file:
                self.zone = zone_file.read().strip()
            return


        path = &#34;pod/clusters&#34;
        url = &#34;{}/{}&#34;.format(self.imandra_web_host, path)
        headers = { &#34;X-Auth&#34; : self.token }

        request = urllib.request.Request(url, headers=headers)

        try:
            response = urllib.request.urlopen(request)
        except urllib.error.HTTPError as e:
            raise ValueError(e.read())
        j = json.loads(response.read())

        options = []
        option_strs = []
        for i, cluster in enumerate(j[&#34;clusters&#34;]):
            options.append((i, cluster))
            option_strs.append(&#34;[{}] {}&#34;.format(str(i + 1), cluster))

        def ask_for_selection():
            query = input(&#34;Select cloud zone {} : &#34;.format(&#34; &#34;.join(option_strs)))
            try:
                return int(query) - 1
            except ValueError:
                print(&#34;Not a valid selection&#34;)
                ask_for_selection()

        selected_opt_idx = ask_for_selection()
        _, selected_cluster = options[selected_opt_idx]

        with open(zone_path, &#39;w&#39;) as zone_file:
            zone_file.write(selected_cluster)

        self.zone = selected_cluster

    def _make_link(self):
        params = urllib.parse.urlencode(\
          { &#34;audience&#34;       : self.auth0_audience
          , &#34;response_type&#34;  : &#34;code&#34;
          , &#34;client_id&#34;      : self.auth0_client_id
          , &#34;code_challenge&#34; : self.challenge
          , &#34;code_challenge_method&#34; : &#34;S256&#34;
          , &#34;redirect_uri&#34;   : self.redirect_uri
          })
        return &#34;https://{}/{}?{}&#34;.format(self.auth0_base_host, &#34;authorize&#34;, params)

    def _prompt_verify_email(self):
        query = input(&#34;Enter the verification code we sent to your email: &#34;)
        evrid, token, intention = base64.b64decode(query.encode(), altchars=b&#34;-_&#34;).decode(&#34;utf8&#34;).split(&#34;,&#34;)
        params = urllib.parse.urlencode(\
          { &#34;evrid&#34; : evrid
          , &#34;token&#34; : token
          , &#34;intention&#34; : intention })
        url = &#34;{}/{}?{}&#34;.format(self.imandra_web_host, &#34;verify-email&#34;, params)
        headers = { &#34;X-Device-Id&#34;   : self.device_id}
        request = urllib.request.Request(url, headers=headers)
        try:
            response = urllib.request.urlopen(request)
        except urllib.error.HTTPError as e:
            raise ValueError(e.read())

    def _exchange_tokens(self, code_str, token_path):
        tkn = \
          { &#34;grant_type&#34;    : &#34;authorization_code&#34;
          , &#34;client_id&#34;     : self.auth0_client_id
          , &#34;code_verifier&#34; : self.verifier.decode(&#34;utf-8&#34;)
          , &#34;code&#34;          : code_str
          , &#34;redirect_uri&#34;  : self.redirect_uri
          }
        url = &#34;https://{}/{}&#34;.format(self.auth0_base_host, &#34;oauth/token&#34;)
        data = json.dumps(tkn)
        clen = len(data)
        data = data.encode(&#34;utf-8&#34;)
        request = urllib.request.Request(url, data, {&#39;Content-Type&#39;: &#39;application/json&#39;, &#39;Content-Length&#39;: clen})
        try:
            response = urllib.request.urlopen(request)
        except urllib.error.HTTPError as e:
            raise ValueError(e.read())
        auth_token = json.loads(response.read())
        headers = \
          { &#34;Authorization&#34; : &#34;Bearer {}&#34;.format(auth_token[&#39;access_token&#39;])
          , &#34;X-Device-Id&#34;   : self.device_id
          }
        url = &#34;{}/{}&#34;.format(self.imandra_web_host, &#34;api/login-token-for&#34;)
        request = urllib.request.Request(url, headers=headers)
        try:
            response = urllib.request.urlopen(request)
            self.token = response.read().decode(&#34;utf-8&#34;)

            with open(token_path, &#39;w&#39;) as token_file:
                token_file.write(self.token)

        except urllib.error.HTTPError as e:
            content = e.read().decode(&#34;utf-8&#34;)
            if e.code == 400 and content == &#34;email-not-verified&#34;:
                self._prompt_verify_email()
                self.ensure_token()
            else:
                raise ValueError(content)

    def ensure_confirm(self):
        path = &#34;api/user-info&#34;
        url = &#34;{}/{}&#34;.format(self.imandra_web_host, path)
        headers = { &#34;X-Auth&#34; : self.token }

        request = urllib.request.Request(url, headers=headers)

        try:
            response = urllib.request.urlopen(request)
        except urllib.error.HTTPError as e:
            raise ValueError(e.read())
        j = json.loads(response.read())
        if not j[&#34;trial_activated&#34;]:
            query = input(&#34;Do you want to start your Imandra trial? [Y/n] &#34;)
            if query == &#34;&#34; or query[0].lower() == &#34;y&#34;:
                path = &#34;welcome/activate-trial&#34;
                url = &#34;{}/{}&#34;.format(self.imandra_web_host, path)
                request = urllib.request.Request(url, headers=headers)
                try:
                    response = urllib.request.urlopen(request)
                except urllib.error.HTTPError as e:
                    raise ValueError(e.read())
            else:
                raise ValueError(&#34;Trial not activated&#34;)

    def export(self):
        &#34;&#34;&#34;
        Export your login details for use via another Imandra Cloud API client.
        &#34;&#34;&#34;
        token_path = os.path.join(self.folder_path, &#34;login_token&#34;)
        zone_path = os.path.join(self.folder_path, &#34;zone&#34;)
        on_behalf_of_path = os.path.join(self.folder_path, &#34;on_behalf_of&#34;)

        if not os.path.exists(token_path) or not os.path.exists(zone_path):
            raise ValueError(&#34;Not logged in&#34;)

        details = {}
        with open(token_path, &#39;r&#39;) as token_file:
            details[&#39;auth&#39;] = token_file.read().strip()

        with open(zone_path, &#39;r&#39;) as zone_file:
            details[&#39;zone&#39;] = zone_file.read().strip()

        if os.path.exists(on_behalf_of_path):
            with open(on_behalf_of_path, &#39;r&#39;) as on_behalf_of_file:
                details[&#39;on_behalf_of&#39;] = on_behalf_of_file.read().strip()
        else:
            details[&#39;on_behalf_of&#39;] = None

        print(json.dumps(details))

    def import_(self):
        &#34;&#34;&#34;
        Import your login details from stdin.
        &#34;&#34;&#34;
        token_path = os.path.join(self.folder_path, &#34;login_token&#34;)
        zone_path = os.path.join(self.folder_path, &#34;zone&#34;)
        on_behalf_of_path = os.path.join(self.folder_path, &#34;on_behalf_of&#34;)

        lines = []
        for line in sys.stdin:
            lines.append(line)

        j = json.loads(&#34;\n&#34;.join(lines))

        if j.get(&#39;auth&#39;):
            self.ensure_folder()
            with open(token_path, &#39;w&#39;) as f:
                f.write(j[&#39;auth&#39;])

        if j.get(&#39;zone&#39;):
            self.ensure_folder()
            with open(zone_path, &#39;w&#39;) as f:
                f.write(j[&#39;zone&#39;])

        if j.get(&#39;on_behalf_of&#39;):
            self.ensure_folder()
            with open(on_behalf_of_path, &#39;w&#39;) as f:
                f.write(j[&#39;zone&#39;])</code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="imandra.auth.Auth.ensure_confirm"><code class="name flex">
<span>def <span class="ident">ensure_confirm</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def ensure_confirm(self):
    path = &#34;api/user-info&#34;
    url = &#34;{}/{}&#34;.format(self.imandra_web_host, path)
    headers = { &#34;X-Auth&#34; : self.token }

    request = urllib.request.Request(url, headers=headers)

    try:
        response = urllib.request.urlopen(request)
    except urllib.error.HTTPError as e:
        raise ValueError(e.read())
    j = json.loads(response.read())
    if not j[&#34;trial_activated&#34;]:
        query = input(&#34;Do you want to start your Imandra trial? [Y/n] &#34;)
        if query == &#34;&#34; or query[0].lower() == &#34;y&#34;:
            path = &#34;welcome/activate-trial&#34;
            url = &#34;{}/{}&#34;.format(self.imandra_web_host, path)
            request = urllib.request.Request(url, headers=headers)
            try:
                response = urllib.request.urlopen(request)
            except urllib.error.HTTPError as e:
                raise ValueError(e.read())
        else:
            raise ValueError(&#34;Trial not activated&#34;)</code></pre>
</details>
</dd>
<dt id="imandra.auth.Auth.ensure_folder"><code class="name flex">
<span>def <span class="ident">ensure_folder</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Ensures the existence of the local imandra configuration directory (<code>~/.imandra</code> or <code>%APPDATA%\imandra</code>).</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def ensure_folder(self):
    &#34;&#34;&#34;
    Ensures the existence of the local imandra configuration directory (`~/.imandra` or `%APPDATA%\imandra`).
    &#34;&#34;&#34;
    if not os.path.exists(self.folder_path):
        os.mkdir(self.folder_path)

    device_id_path = os.path.join(self.folder_path, &#34;device_id&#34;)
    if not os.path.exists(device_id_path):
        self.device_id = str(uuid.uuid4())
        with open(device_id_path, &#39;w&#39;) as device_id_file:
            device_id_file.write(self.device_id)
    else:
        with open(device_id_path, &#39;r&#39;) as device_id_file:
            self.device_id = device_id_file.read()</code></pre>
</details>
</dd>
<dt id="imandra.auth.Auth.ensure_token"><code class="name flex">
<span>def <span class="ident">ensure_token</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Ensures the existence of the local imandra login token. Prompts the user to log in if there isn't one.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def ensure_token(self):
    &#34;&#34;&#34;
    Ensures the existence of the local imandra login token. Prompts the user to log in if there isn&#39;t one.
    &#34;&#34;&#34;
    token_path = os.path.join(self.folder_path, &#34;login_token&#34;)
    if os.path.exists(token_path):
        with open(token_path, &#39;r&#39;) as token_file:
            self.token = token_file.read().strip()
        return

    self.verifier, self.challenge = _get_secrets()
    link = self._make_link()
    try:
        webbrowser.open(link)
    except webbrowser.Error:
        print(&#34;We need to authenticate you! Please open: \n{}&#34;.format(link))
    code_str = str(input(&#34;Enter the code provided on the page above: &#34;)).strip()
    self._exchange_tokens(code_str, token_path)</code></pre>
</details>
</dd>
<dt id="imandra.auth.Auth.ensure_zone"><code class="name flex">
<span>def <span class="ident">ensure_zone</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Ensures the existence of the default zone for creation of Imandra core
instances. Pick the zone closest to you from those available to reduce
latency when interacting with Imandra Core instances.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def ensure_zone(self):
    &#34;&#34;&#34;
    Ensures the existence of the default zone for creation of Imandra core
    instances. Pick the zone closest to you from those available to reduce
    latency when interacting with Imandra Core instances.
    &#34;&#34;&#34;
    zone_path = os.path.join(self.folder_path, &#34;zone&#34;)
    if os.path.exists(zone_path):
        with open(zone_path, &#39;r&#39;) as zone_file:
            self.zone = zone_file.read().strip()
        return


    path = &#34;pod/clusters&#34;
    url = &#34;{}/{}&#34;.format(self.imandra_web_host, path)
    headers = { &#34;X-Auth&#34; : self.token }

    request = urllib.request.Request(url, headers=headers)

    try:
        response = urllib.request.urlopen(request)
    except urllib.error.HTTPError as e:
        raise ValueError(e.read())
    j = json.loads(response.read())

    options = []
    option_strs = []
    for i, cluster in enumerate(j[&#34;clusters&#34;]):
        options.append((i, cluster))
        option_strs.append(&#34;[{}] {}&#34;.format(str(i + 1), cluster))

    def ask_for_selection():
        query = input(&#34;Select cloud zone {} : &#34;.format(&#34; &#34;.join(option_strs)))
        try:
            return int(query) - 1
        except ValueError:
            print(&#34;Not a valid selection&#34;)
            ask_for_selection()

    selected_opt_idx = ask_for_selection()
    _, selected_cluster = options[selected_opt_idx]

    with open(zone_path, &#39;w&#39;) as zone_file:
        zone_file.write(selected_cluster)

    self.zone = selected_cluster</code></pre>
</details>
</dd>
<dt id="imandra.auth.Auth.export"><code class="name flex">
<span>def <span class="ident">export</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Export your login details for use via another Imandra Cloud API client.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def export(self):
    &#34;&#34;&#34;
    Export your login details for use via another Imandra Cloud API client.
    &#34;&#34;&#34;
    token_path = os.path.join(self.folder_path, &#34;login_token&#34;)
    zone_path = os.path.join(self.folder_path, &#34;zone&#34;)
    on_behalf_of_path = os.path.join(self.folder_path, &#34;on_behalf_of&#34;)

    if not os.path.exists(token_path) or not os.path.exists(zone_path):
        raise ValueError(&#34;Not logged in&#34;)

    details = {}
    with open(token_path, &#39;r&#39;) as token_file:
        details[&#39;auth&#39;] = token_file.read().strip()

    with open(zone_path, &#39;r&#39;) as zone_file:
        details[&#39;zone&#39;] = zone_file.read().strip()

    if os.path.exists(on_behalf_of_path):
        with open(on_behalf_of_path, &#39;r&#39;) as on_behalf_of_file:
            details[&#39;on_behalf_of&#39;] = on_behalf_of_file.read().strip()
    else:
        details[&#39;on_behalf_of&#39;] = None

    print(json.dumps(details))</code></pre>
</details>
</dd>
<dt id="imandra.auth.Auth.import_"><code class="name flex">
<span>def <span class="ident">import_</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Import your login details from stdin.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def import_(self):
    &#34;&#34;&#34;
    Import your login details from stdin.
    &#34;&#34;&#34;
    token_path = os.path.join(self.folder_path, &#34;login_token&#34;)
    zone_path = os.path.join(self.folder_path, &#34;zone&#34;)
    on_behalf_of_path = os.path.join(self.folder_path, &#34;on_behalf_of&#34;)

    lines = []
    for line in sys.stdin:
        lines.append(line)

    j = json.loads(&#34;\n&#34;.join(lines))

    if j.get(&#39;auth&#39;):
        self.ensure_folder()
        with open(token_path, &#39;w&#39;) as f:
            f.write(j[&#39;auth&#39;])

    if j.get(&#39;zone&#39;):
        self.ensure_folder()
        with open(zone_path, &#39;w&#39;) as f:
            f.write(j[&#39;zone&#39;])

    if j.get(&#39;on_behalf_of&#39;):
        self.ensure_folder()
        with open(on_behalf_of_path, &#39;w&#39;) as f:
            f.write(j[&#39;zone&#39;])</code></pre>
</details>
</dd>
<dt id="imandra.auth.Auth.login"><code class="name flex">
<span>def <span class="ident">login</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Ensures that all information is present in order to make calls to the
API. This method is best run interactively from <code>imandra-cli</code>, via
<code><a title="imandra" href="index.html">imandra</a> auth login</code>.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def login(self):
    &#34;&#34;&#34;
    Ensures that all information is present in order to make calls to the
    API. This method is best run interactively from `imandra-cli`, via
    `imandra auth login`.
    &#34;&#34;&#34;
    self.ensure_folder()
    self.ensure_token()
    self.ensure_confirm()
    self.ensure_zone()</code></pre>
</details>
</dd>
<dt id="imandra.auth.Auth.logout"><code class="name flex">
<span>def <span class="ident">logout</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Remove all Imandra user configuration information on the local machine.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def logout(self):
    &#34;&#34;&#34;
    Remove all Imandra user configuration information on the local machine.
    &#34;&#34;&#34;
    self.ensure_folder()
    shutil.rmtree(self.folder_path)</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="imandra" href="index.html">imandra</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="imandra.auth.Auth" href="#imandra.auth.Auth">Auth</a></code></h4>
<ul class="two-column">
<li><code><a title="imandra.auth.Auth.ensure_confirm" href="#imandra.auth.Auth.ensure_confirm">ensure_confirm</a></code></li>
<li><code><a title="imandra.auth.Auth.ensure_folder" href="#imandra.auth.Auth.ensure_folder">ensure_folder</a></code></li>
<li><code><a title="imandra.auth.Auth.ensure_token" href="#imandra.auth.Auth.ensure_token">ensure_token</a></code></li>
<li><code><a title="imandra.auth.Auth.ensure_zone" href="#imandra.auth.Auth.ensure_zone">ensure_zone</a></code></li>
<li><code><a title="imandra.auth.Auth.export" href="#imandra.auth.Auth.export">export</a></code></li>
<li><code><a title="imandra.auth.Auth.import_" href="#imandra.auth.Auth.import_">import_</a></code></li>
<li><code><a title="imandra.auth.Auth.login" href="#imandra.auth.Auth.login">login</a></code></li>
<li><code><a title="imandra.auth.Auth.logout" href="#imandra.auth.Auth.logout">logout</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>